name: CI Drift

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  drift:
    name: Spec Drift Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run drift validation
        shell: bash
        run: |
          set -euo pipefail

          if [ -f scripts/check_drift.py ]; then
            python scripts/check_drift.py
            exit 0
          fi

          spec_count=0
          if [ -d .specs ]; then
            spec_count=$(find .specs -type f ! -name '.gitkeep' | wc -l)
          fi

          src_count=0
          if [ -d src ]; then
            src_count=$(find src -type f | wc -l)
          fi

          if [ "$spec_count" -eq 0 ] && [ "$src_count" -eq 0 ]; then
            echo "Bootstrap state detected: no actionable .specs/ or src/ files yet."
            exit 0
          fi

          echo "Drift checker is required once .specs/ or src/ are populated."
          exit 1
