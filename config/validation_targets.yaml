# verify #2 레코드 건수는 전일 대비 절대 변동률이 50% 이상(>= 0.5)일 때 실패로 간주한다.
# 전일 건수가 0이면 당일 건수 > 0을 실패로, 당일 건수도 0이면 통과로 간주한다.
verify:
  check_1:
    table: "gold.pipeline_state"
    pk: ["pipeline_name"]
    expected_status: "success"
    failure_policy: "escalate_without_rollback"

  check_2:
    targets:
      - table: "silver.wallet_snapshot"
        pk: ["snapshot_ts", "user_id"]
      - table: "silver.ledger_entries"
        pk: ["tx_id", "wallet_id"]
    max_change_ratio: 0.5
    failure_comparison: ">="
    zero_baseline_policy: "fail_if_current_positive"
    rollback_on_failure: true

  check_3:
    targets:
      - table: "silver.wallet_snapshot"
        pk: ["snapshot_ts", "user_id"]
      - table: "silver.ledger_entries"
        pk: ["tx_id", "wallet_id"]
    duplicate_threshold: 1
    failure_comparison: ">="
    rollback_on_failure: true

  check_4:
    table: "silver.dq_status"
    pk: ["run_id", "source_table"]
    dq_tags: ["SOURCE_STALE", "EVENT_DROP_SUSPECTED"]
    rollback_on_failure: false

  check_5:
    table: "silver.dq_status"
    pk: ["run_id", "source_table"]
    bad_records_rate_threshold: 0.05
    failure_comparison: ">"
    rollback_on_failure: true

rollback:
  delta_tables:
    - table: "silver.wallet_snapshot"
      pk: ["snapshot_ts", "user_id"]
    - table: "silver.ledger_entries"
      pk: ["tx_id", "wallet_id"]
