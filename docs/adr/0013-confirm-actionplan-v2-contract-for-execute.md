# ADR-0013: Confirm ActionPlan v2 contract for execute

## Created At

2026-02-23 22:34 KST

## Status

Confirmed

## Context

DEV-055에서 ActionPlan의 execute 경로를 v2 이상 버전에 대해 활성화하면서, 실행 전에 어떤 상위 필드 구성을 허용할지 명확히 고정할 필요가 생겼다. v2+는 에이전트 출력의 일관성과 운영 검증 가능성을 높이기 위해 `schema_version`, `action`, `parameters`를 필수로 요구하고, 선택 필드는 `expected_outcome`(문자열)과 `caveats`(문자열 리스트)로 제한하며, 이외의 미정의 상위 필드는 거부해야 한다. 반면 기존 v1(버전 미명시) 플로우는 이미 느슨한 상위 구조를 전제로 동작 중이므로, 동일한 엄격 검증을 즉시 적용하면 기존 호출과의 호환성이 깨질 수 있다.

## Decision

ActionPlan execute 경로는 v2 이상에 대해서만 상위 계약을 엄격히 적용하여 필수/선택 필드를 고정하고 미정의 상위 필드를 거부하되, v1(버전 미명시)은 기존의 완화된 상위 동작을 유지하기로 결정한다.

## Rationale

대안 1은 v1과 v2+ 모두에 엄격 상위 계약을 일괄 적용하는 방식으로, 규칙 단순화와 검증 일관성은 높지만 기존 v1 사용자의 입력이 대량으로 실패할 수 있어 즉시 적용 리스크가 크다. 대안 2는 v2+에서도 상위 필드를 계속 느슨하게 허용하는 방식으로, 단기 호환성은 좋지만 스키마 드리프트와 예기치 않은 필드 유입을 제어하기 어렵고 execute 안정성 목표와 충돌한다. 최종 선택안은 버전별 정책을 분리해 v2+에서 계약 엄격성을 확보하면서 v1 호환성을 보존하는 절충안으로, 검증 로직이 이원화되는 복잡도 비용이 생기지만 점진적 전환과 운영 안정성 측면에서 가장 실용적이다.

## v1 Strict 전환 트리거

v1(무버전) 상위 계약을 v2+와 동일한 엄격 모드로 전환하려면 아래 3개 축을 모두 충족해야 한다.

1. 호환성 영향: 최근 14일 execute 입력에서 v1 무버전 입력 비중이 충분히 낮거나(권고: 5% 이하), 호출 주체별 마이그레이션 소유자가 확정되어 있어야 한다.
2. 실패 패턴: v1 완화 정책 때문에 발생한 상위 필드 드리프트/운영 혼선이 반복적으로 관측되어야 한다(권고: 주간 2건 이상, 2주 연속).
3. 마이그레이션 준비도: 호출 경로별로 `schema_version` 주입 및 required/optional 필드 계약 충족 검증이 사전 테스트에서 통과해야 한다.

## 적용 절차 (관측 지표/전환 조건)

1. 관측 기간(최소 2주):
   - `execute.action_plan.version=v1|v2_plus` 분포
   - v1 경로에서 미정의 상위 필드 유입 건수
   - `schema_version="v1"` 명시 입력 거부 건수
2. 전환 준비 게이트:
   - v1 호출 주체별 마이그레이션 체크리스트 100% 완료
   - 회귀 테스트에서 v1 strict 모드 실패/성공 케이스가 모두 재현 가능
   - 운영 알림/런북에 전환 일정 및 롤백 기준 반영
3. 단계적 전환:
   - 1단계: 비차단 경고(드리프트 감지) 강화
   - 2단계: 스테이징 strict 적용 + 회귀 검증
   - 3단계: 프로덕션 strict 적용
4. 롤백 조건:
   - 전환 후 24시간 내 실행 실패율 급증(권고: 기준 대비 2배 이상) 또는 핵심 파이프라인 MTTR 악화가 확인되면 즉시 v1 완화 정책으로 복귀한다.
